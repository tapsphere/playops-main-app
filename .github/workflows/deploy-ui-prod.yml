name: CI/CD â†’ Hetzner (PlayOps UI PROD)
 
on:
  # Manual deploy for now; can add push->main later
  workflow_dispatch:
 
env:
  # --- Hetzner SSH (PROD) ---
  HZ_HOST:                   ${{ secrets.HZ_HOST_PROD }}
  HZ_USER:                   ${{ secrets.HZ_USER_PROD }}
 
  # --- Vite / Supabase / Thirdweb (PROD) ---
  VITE_SUPABASE_URL:         ${{ secrets.VITE_SUPABASE_URL }}
  VITE_SUPABASE_PROJECT_ID:  ${{ secrets.VITE_SUPABASE_PROJECT_ID }}
  VITE_SUPABASE_PUBLISHABLE_KEY: ${{ secrets.VITE_SUPABASE_PUBLISHABLE_KEY }}
  VITE_SUPABASE_STORAGE_URL: ${{ secrets.VITE_SUPABASE_STORAGE_URL }}
  VITE_THIRDWEB_CLIENT_ID:   ${{ secrets.VITE_THIRDWEB_CLIENT_ID }}
 
jobs:
  deploy:
    name: Build & Deploy PlayOps UI (PROD)
    runs-on: ubuntu-latest
    environment: prod-server
 
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
 
      - name: Use Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
 
      - name: Install dependencies
        working-directory: .
        run: |
          npm ci
 
      - name: Build production bundle
        working-directory: .
        env:
          VITE_SUPABASE_URL:            ${{ env.VITE_SUPABASE_URL }}
          VITE_SUPABASE_PROJECT_ID:     ${{ env.VITE_SUPABASE_PROJECT_ID }}
          VITE_SUPABASE_PUBLISHABLE_KEY:${{ env.VITE_SUPABASE_PUBLISHABLE_KEY }}
          VITE_SUPABASE_STORAGE_URL:    ${{ env.VITE_SUPABASE_STORAGE_URL }}
          VITE_THIRDWEB_CLIENT_ID:      ${{ env.VITE_THIRDWEB_CLIENT_ID }}
        run: |
          npm run build
 
      - name: Show dist contents
        working-directory: .
        run: |
          du -sh dist || true
          ls -la dist | sed -n '1,120p' || true
 
      - name: Start SSH agent and add key (Hetzner PROD)
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: |
            ${{ secrets.HZ_SSH_KEY_PROD }}
 
      - name: Add Hetzner PROD host to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H "${{ env.HZ_HOST }}" >> ~/.ssh/known_hosts
          chmod 600 ~/.ssh/known_hosts
 
      - name: Rsync dist to Hetzner (/var/www/playops-ui)
        run: |
          RSYNC_RSH="ssh -o StrictHostKeyChecking=yes"
          rsync -az --delete --omit-dir-times \
            -e "$RSYNC_RSH" \
            ./dist/ "${{ env.HZ_USER }}@${{ env.HZ_HOST }}:/var/www/playops-ui"
 
      - name: Ensure perms and reload Caddy on Hetzner
        run: |
          ssh -o StrictHostKeyChecking=yes "${{ env.HZ_USER }}@${{ env.HZ_HOST }}" '
            set -e
            sudo mkdir -p /var/www/playops-ui
            sudo chown -R root:caddy /var/www/playops-ui || sudo chown -R root:root /var/www/playops-ui || true
            sudo chmod -R 755 /var/www/playops-ui || true
            sudo systemctl reload caddy || sudo systemctl restart caddy
          '
 
      - name: Post-deploy quick check (best-effort)
        run: |
          echo "Attempting quick GET (may fail if DNS/certs not ready)..."
          curl -I "https://playops-main-app.tapsphere.io" -m 10 || true
